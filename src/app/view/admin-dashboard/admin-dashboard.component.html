<html lang="fr">

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css" rel="stylesheet">
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <i class="fas fa-hashtag"></i> AUTOWASH
    </div>
    <div class="user-profile" *ngIf="currentUser">
      <div class="user-photo-container">
        <img *ngIf="currentUser.photoSafeUrl" [src]="currentUser.photoSafeUrl"
          [alt]="'Photo de ' + (currentUser.firstName || 'Utilisateur')" class="user-avatar">
        <div *ngIf="!currentUser.photoSafeUrl" class="user-initials">
          {{ (currentUser.firstName?.charAt(0) || '') + (currentUser.lastName?.charAt(0) || '') }}
        </div>
      </div>
      <div class="user-info">
        <h4>{{ getFullName() }}</h4>
        <p>{{ getUserRole() }}</p>
      </div>
    </div>
    <div class="nav-menu">
      <!-- Dashboard -->
      <div class="dropdown dropdown-hover">
        <a class="nav-item active" data-mdb-dropdown-init [routerLink]="['/admin/dashboard']">
          <i class="fas fa-tachometer-alt"></i>
          <span>Tableau de bord</span>
        </a>
      </div>

      <!-- Gestion des Utilisateurs -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-users-cog"></i>
          <span>Utilisateurs</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/users-list']"><i class="fas fa-list"></i> Liste des
              utilisateurs</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/users-create']"><i class="fas fa-user-plus"></i> Ajouter
              un utilisateur</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/users-attendance']"><i class="fas fa-user-clock"></i>
              Présences</a></li>
        </ul>
      </div>

      <!-- Centres de Lavage -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fa-solid fa-car"></i>
          <span>Centres</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/centres-list']"><i class="fas fa-list"></i> Tous les
              centres</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/centres-create']"><i class="fas fa-plus-circle"></i>
              Nouveau centre</a></li>
        </ul>
      </div>

      <!-- Sessions de Lavage -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-car-side"></i>
          <span>Lavages</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/wash-sessions']"><i class="fas fa-list"></i> Toutes les
              sessions</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/wash-now']"><i class="fas fa-play-circle"></i> Nouveau
              lavage</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/wash-queue']"><i class="fas fa-clock"></i> File
              d'attente</a></li>
        </ul>
      </div>

      <!-- Paiements -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-money-bill-wave"></i>
          <span>Paiements</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-washers']"><i class="fas fa-user-tie"></i>
              Paiements laveurs</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-customers']"><i class="fas fa-users"></i>
              Paiements clients</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-manager']"><i class="fas fa-user-tie"></i>
              Paiement gérant</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-reports']"><i
                class="fas fa-file-invoice-dollar"></i> Rapports</a></li>
        </ul>
      </div>

      <!-- Stocks -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-box-open"></i>
          <span>Stocks</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-list']"><i class="fas fa-boxes"></i> Inventaire</a>
          </li>
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-alerts']"><i
                class="fas fa-exclamation-triangle"></i> Alertes stock</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-movements']"><i class="fas fa-exchange-alt"></i>
              Mouvements</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-suppliers']"><i class="fas fa-truck"></i>
              Fournisseurs</a></li>
        </ul>
      </div>

      <!-- Statistiques & Rapports -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-chart-pie"></i>
          <span>Statistiques</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-daily']"><i class="fas fa-calendar-day"></i>
              Journalier</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-weekly']"><i class="fas fa-calendar-week"></i>
              Hebdomadaire</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-monthly']"><i class="fas fa-calendar-alt"></i>
              Mensuel</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-comparison']"><i class="fas fa-balance-scale"></i>
              Comparaison</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-export']"><i class="fas fa-file-export"></i>
              Exports</a></li>
        </ul>
      </div>

      <!-- Audit -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-clipboard-check"></i>
          <span>Audit</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/audit-logs']"><i class="fas fa-clipboard-list"></i>
              Journal d'activité</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/audit-changes']"><i class="fas fa-history"></i> Historique
              modifications</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/audit-security']"><i class="fas fa-shield-alt"></i>
              Sécurité</a></li>
        </ul>
      </div>

      <!-- Dépenses -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Dépenses</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/expenses-utilities']"><i class="fas fa-tint"></i>Gestion
              dépenses</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/expenses-profitability']"><i
                class="fas fa-chart-line"></i> Rentabilité</a></li>
        </ul>
      </div>

      <!-- Paramètres -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-cogs"></i>
          <span>Paramètres</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-schedule']"><i class="fas fa-clock"></i>
              Horaires</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-services']"><i class="fas fa-concierge-bell"></i>
              Prestations</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-vehicles']"><i class="fas fa-car"></i> Types de
              véhicules</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-notifications']"><i class="fas fa-bell"></i>
              Notifications</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-system']"><i class="fas fa-sliders-h"></i>
              Système</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-templates']"><i class="fas fa-file-alt"></i>
              Modèles de paramètres</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <div class="top-bar">
      <div class="menu-toggle" id="menu-toggle" (click)="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </div>
      <div class="top-right">
        <div class="icon-button">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="icon-button">
          <i class="fas fa-bell"></i>
          <span class="badge">3</span>
        </div>
        <div class="dropdown dropdown-hover">
          <button class="user-dropdown" id="user-dropdown" data-mdb-dropdown-init>
            <!-- Photo sécurisée si elle existe -->
            <img *ngIf="currentUser?.photoSafeUrl as safeUrl" [src]="safeUrl" alt="User" class="user-avatar">
            <!-- Nom complet -->
            <span>{{ currentUser?.firstName }} {{ currentUser?.lastName }}</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-hover" id="user-dropdown-menu">
            <li><a class="dropdown-item" [routerLink]="['/admin/users-profil']"><i class="fas fa-user"></i> Mon
                profil</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Paramètres</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-envelope"></i> Inbox</a></li>
            <li><a class="dropdown-item" (click)="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="page-content">
      <div class="container">
        <!-- En-tête avec sélecteur de centre -->
        <div class="dashboard-header">
          <div class="header-content">
            <div>
              <p class="dashboard-subtitle">Statistiques et analyses en temps réel</p>
            </div>
            <div class="center-selector"> CHOISIR UN CENTRE :
              <select class="center-select" id="centerSelect" [(ngModel)]="selectedCentreId" (change)="onCentreChange()"
                [disabled]="loadingCentres">
                <option *ngFor="let centre of centres" [value]="centre.id">
                  {{ centre.name }} ({{ centre.location }})
                </option>
              </select>
              <div *ngIf="loadingCentres" class="loading-spinner-small">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
            </div>
          </div>
        </div>


        <!-- Section de filtres avec sécurité -->
        <div class="filters-section">
          <h2 class="filters-title">Filtres d'analyse</h2>
          <div class="filters-grid">

            <!-- Filtre Centre avec restriction d'accès -->
            <div class="filter-group">
              <label class="filter-label">Centre</label>
              <select class="filter-select" id="centreFilter" [(ngModel)]="selectedCentreId" (change)="onCentreChange()"
                [disabled]="loadingCentres || centres.length === 0">
                <option value="">Sélectionner un centre</option>
                <option *ngFor="let centre of centres" [value]="centre.id">
                  {{ centre.name }}
                </option>
              </select>
              <div *ngIf="loadingCentres" class="loading-spinner-small">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
            </div>

            <!-- Filtre Période avec validation -->
            <div class="filter-group">
              <label class="filter-label">Période</label>
              <select class="filter-select" id="periodFilter" [(ngModel)]="selectedPeriod"
                (change)="onPeriodChange($event)" [disabled]="!selectedCentreId">
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
                <option value="quarter">Ce trimestre</option>
                <option value="year">Cette année</option>
                <option value="custom">Période personnalisée</option>
              </select>
            </div>

            <!-- Filtre Service avec validation -->
            <div class="filter-group">
              <label class="filter-label">Type de service</label>
              <select class="filter-select" id="serviceFilter" [(ngModel)]="selectedService"
                (change)="onServiceChange($event)"
                [disabled]="loadingServices || !selectedCentreId || services.length === 0">
                <option value="all">Tous les services</option>
                <option *ngFor="let service of services" [value]="service.id">
                  {{ service.name }}
                </option>
              </select>
              <div *ngIf="loadingServices" class="loading-spinner-small">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
            </div>

            <!-- Dates personnalisées avec validation -->
            <div class="filter-group" *ngIf="selectedPeriod === 'custom'">
              <label class="filter-label">Date de début</label>
              <input type="date" class="filter-input" id="startDate" [(ngModel)]="startDate" (change)="onDateChange()"
                [max]="endDate || getCurrentDate()" [disabled]="!selectedCentreId">
            </div>

            <div class="filter-group" *ngIf="selectedPeriod === 'custom'">
              <label class="filter-label">Date de fin</label>
              <input type="date" class="filter-input" id="endDate" [(ngModel)]="endDate" (change)="onDateChange()"
                [min]="startDate" [max]="getCurrentDate()" [disabled]="!selectedCentreId">
            </div>

            <!-- Bouton de rafraîchissement sécurisé -->
            <div class="filter-group">
              <label class="filter-label">&nbsp;</label>
              <button class="refresh-button" (click)="refreshDashboard()"
                [disabled]="!selectedCentreId || loadingDashboard || loadingKpis">
                <i class="fas fa-sync-alt"></i> Rafraîchir </button>
            </div>
          </div>
        </div>

        <!-- Indicateurs de chargement -->
        <div *ngIf="loadingDashboard || loadingKpis" class="loading-overlay">
          <div class="spinner"></div>
          <span>Chargement des données...</span>
        </div>

        <!-- Cartes de statistiques -->
        <div class="stats-cards">
          <div class="stat-card">
            <div class="stat-icon blue">
              <i class="fas fa-franc-sign"></i>
            </div>
            <div class="stat-content">
              <div class="stat-title">Ventes Aujourd'hui</div>
              <div class="stat-value" id="todaySales">
                {{ dashboardData?.todayRevenue }}
              </div>
              <div class="stat-change positive" id="todaySalesChange">
                <i class="fas fa-arrow-up"></i>
                <span>{{ weeklyComparison?.revenueGrowthPercentage?.toFixed(2) }}%</span>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon green">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
              <div class="stat-title">Ventes Totales</div>
              <div class="stat-value" id="totalSales">
                {{ kpiData?.totalWashCount }}
              </div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span></span>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon orange">
              <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
              <div class="stat-title">Revenus Aujourd'hui (Fcfa)</div>
              <div class="stat-value" id="todayRevenue">
                {{ dashboardData?.todayRevenue }}
              </div>
              <div class="stat-change positive" id="todayRevenueChange">
                <i class="fas fa-arrow-up"></i>
                <span>{{ weeklyComparison?.revenueGrowthPercentage?.toFixed(2) || '-' }}%</span>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon purple">
              <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-content">
              <div class="stat-title">Revenus Totaux (Fcfa)</div>
              <div class="stat-value" id="totalRevenue">
                {{ kpiData?.totalRevenue }}
              </div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Graphiques -->
        <div class="charts-container">
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Évolution des Ventes (7 derniers jours)</div>
            </div>
            <div class="chart-content" #salesChart>
              <div *ngIf="loadingCharts" class="loading">
                <div class="spinner"></div>
                <span>Chargement des données...</span>
              </div>
              <div *ngIf="!loadingCharts && (!last7DaysRevenue || last7DaysRevenue.length === 0)"
                class="chart-placeholder">
                <i class="fas fa-chart-bar"></i>
                <p>Aucune donnée disponible</p>
              </div>
              <!-- GRAPHIQUE LINE CHART -->
              <div *ngIf="!loadingCharts && last7DaysRevenue && last7DaysRevenue.length > 0" class="chart-wrapper">
                <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="lineChartType" width="400"
                  height="300">
                </canvas>
              </div>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Revenus par Service</div>
            </div>
            <div class="chart-content" #revenueChart>
              <div *ngIf="loadingCharts" class="loading">
                <div class="spinner"></div>
                <span>Chargement des données...</span>
              </div>
              <div *ngIf="!loadingCharts && (!services || services.length === 0)" class="chart-placeholder">
                <i class="fas fa-chart-pie"></i>
                <p>Aucun service disponible</p>
              </div>
              <!-- GRAPHIQUE PIE CHART -->
              <div *ngIf="!loadingCharts && services && services.length > 0" class="chart-wrapper">
                <canvas baseChart [data]="pieChartData" [options]="pieChartOptions" [type]="pieChartType" width="400"
                  height="300">
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>©2026 AutoWash, Tous droit reservé.</div>
      <div>Crée par <a href="https://www.linkedin.com/in/afferyauxencedelorschabehou/">Affery Auxence Delors
          CHABEHOU</a></div>
    </div>
  </div>
</body>

</html>
