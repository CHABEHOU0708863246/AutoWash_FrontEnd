<html lang="fr">

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css" rel="stylesheet">
</head>

<body>
  <!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="logo">
    <i class="fas fa-hashtag"></i> AUTOWASH
  </div>
  <div class="user-profile" *ngIf="currentUser">
    <div class="user-photo-container">
      <img *ngIf="currentUser.photoSafeUrl" [src]="currentUser.photoSafeUrl"
        [alt]="'Photo de ' + (currentUser.firstName || 'Utilisateur')" class="user-avatar">
      <div *ngIf="!currentUser.photoSafeUrl" class="user-initials">
        {{ (currentUser.firstName?.charAt(0) || '') + (currentUser.lastName?.charAt(0) || '') }}
      </div>
    </div>
    <div class="user-info">
      <h4>{{ getFullName() }}</h4>
      <p>{{ getUserRole() }}</p>
    </div>
  </div>
  <div class="nav-menu">
    <!-- Dashboard -->
    <div class="dropdown dropdown-hover">
      <a class="nav-item active" data-mdb-dropdown-init [routerLink]="['/admin/dashboard']">
        <i class="fas fa-tachometer-alt"></i>
        <span>Tableau de bord</span>
      </a>
    </div>

    <!-- Gestion des Utilisateurs -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-users-cog"></i>
        <span>Utilisateurs</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/users-list']"><i class="fas fa-list"></i> Liste des utilisateurs</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/users-create']"><i class="fas fa-user-plus"></i> Ajouter un utilisateur</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/users-attendance']"><i class="fas fa-user-clock"></i> Présences</a></li>
      </ul>
    </div>

    <!-- Centres de Lavage -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fa-solid fa-car"></i>
        <span>Centres</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/centres-list']"><i class="fas fa-list"></i> Tous les centres</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/centres-create']"><i class="fas fa-plus-circle"></i> Nouveau centre</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/centres-stock']"><i class="fas fa-boxes"></i> Stocks par centre</a></li>
      </ul>
    </div>

    <!-- Sessions de Lavage -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-car-side"></i>
        <span>Lavages</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/wash-sessions']"><i class="fas fa-list"></i> Toutes les sessions</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/wash-now']"><i class="fas fa-play-circle"></i> Nouveau lavage</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/wash-queue']"><i class="fas fa-clock"></i> File d'attente</a></li>
      </ul>
    </div>

    <!-- Paiements -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-money-bill-wave"></i>
        <span>Paiements</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/payments-washers']"><i class="fas fa-user-tie"></i> Paiements laveurs</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/payments-customers']"><i class="fas fa-users"></i> Paiements clients</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/payments-manager']"><i class="fas fa-user-tie"></i>
              Paiement gérant</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/payments-reports']"><i class="fas fa-file-invoice-dollar"></i> Rapports</a></li>
      </ul>
    </div>

    <!-- Stocks -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-box-open"></i>
        <span>Stocks</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/stocks-list']"><i class="fas fa-boxes"></i> Inventaire</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/stocks-alerts']"><i class="fas fa-exclamation-triangle"></i> Alertes stock</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/stocks-movements']"><i class="fas fa-exchange-alt"></i> Mouvements</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/stocks-suppliers']"><i class="fas fa-truck"></i> Fournisseurs</a></li>
      </ul>
    </div>

    <!-- Statistiques & Rapports -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-chart-pie"></i>
        <span>Statistiques</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/reports-daily']"><i class="fas fa-calendar-day"></i> Journalier</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/reports-weekly']"><i class="fas fa-calendar-week"></i> Hebdomadaire</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/reports-monthly']"><i class="fas fa-calendar-alt"></i> Mensuel</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/reports-comparison']"><i class="fas fa-balance-scale"></i> Comparaison</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/reports-export']"><i class="fas fa-file-export"></i> Exports</a></li>
      </ul>
    </div>

    <!-- Audit -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-clipboard-check"></i>
        <span>Audit</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/audit-logs']"><i class="fas fa-clipboard-list"></i> Journal d'activité</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/audit-changes']"><i class="fas fa-history"></i> Historique modifications</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/audit-security']"><i class="fas fa-shield-alt"></i> Sécurité</a></li>
      </ul>
    </div>

    <!-- Dépenses -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-file-invoice-dollar"></i>
        <span>Dépenses</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/expenses-utilities']"><i class="fas fa-tint"></i>Gestion dépenses</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/expenses-profitability']"><i class="fas fa-chart-line"></i> Rentabilité</a></li>
      </ul>
    </div>

    <!-- Paramètres -->
    <div class="dropdown dropdown-hover">
      <button class="nav-item" data-mdb-dropdown-init>
        <i class="fas fa-cogs"></i>
        <span>Paramètres</span>
        <i class="fas fa-chevron-right dropdown-arrow"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-hover">
        <li><a class="dropdown-item" [routerLink]="['/admin/settings-schedule']"><i class="fas fa-clock"></i> Horaires</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/settings-services']"><i class="fas fa-concierge-bell"></i> Prestations</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/settings-vehicles']"><i class="fas fa-car"></i> Types de véhicules</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/settings-notifications']"><i class="fas fa-bell"></i> Notifications</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/settings-system']"><i class="fas fa-sliders-h"></i> Système</a></li>
        <li><a class="dropdown-item" [routerLink]="['/admin/settings-templates']"><i class="fas fa-file-alt"></i> Modèles de paramètres</a></li>
      </ul>
    </div>
  </div>
</div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <div class="top-bar">
      <div class="menu-toggle" id="menu-toggle" (click)="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </div>
      <div class="top-right">
        <div class="icon-button">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="icon-button">
          <i class="fas fa-bell"></i>
          <span class="badge">3</span>
        </div>
        <div class="dropdown dropdown-hover">
          <button class="user-dropdown" id="user-dropdown" data-mdb-dropdown-init>
            <!-- Photo sécurisée si elle existe -->
            <img *ngIf="currentUser?.photoSafeUrl as safeUrl" [src]="safeUrl" alt="User" class="user-avatar">
            <!-- Nom complet -->
            <span>{{ currentUser?.firstName }} {{ currentUser?.lastName }}</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-hover" id="user-dropdown-menu">
             <li><a class="dropdown-item" [routerLink]="['/admin/users-profil']"><i class="fas fa-user"></i> Mon profil</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Paramètres</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-envelope"></i> Inbox</a></li>
            <li><a class="dropdown-item" (click)="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
          </ul>
        </div>
      </div>
    </div>

<div class="page-content">
  <!-- En-tête de page -->
  <div class="page-header">
    <h1 class="page-title"><i class="fas fa-chart-line"></i> Analyse de Rentabilité</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="refreshData()" [disabled]="isLoading">
        <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
        {{ isLoading ? 'Chargement...' : 'Rafraîchir' }}
      </button>
      <button class="btn btn-primary" (click)="exportToExcel()" [disabled]="!profitabilityData || isLoading">
        <i class="fas fa-file-excel"></i> Exporter Excel
      </button>
      <a [routerLink]="['/admin/dashboard']" class="back-button">
        <i class="fas fa-arrow-left"></i> Retour au Tableau de Bord
      </a>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="errorMessage" class="error-message">
    <i class="fas fa-exclamation-triangle"></i> {{ errorMessage }}
    <button class="close-btn" (click)="errorMessage = ''">×</button>
  </div>

  <!-- Indicateur de chargement -->
  <div *ngIf="isLoading" class="loading-indicator">
    <i class="fas fa-spinner fa-spin"></i> Chargement des données de rentabilité...
  </div>

  <!-- Cartes de statistiques -->
  <div class="stats-cards" *ngIf="profitabilityData && !isLoading">
    <div class="stat-card">
      <div class="stat-icon blue">
        <i class="fas fa-money-bill-wave"></i>
      </div>
      <div class="stat-content">
        <div class="stat-title">Revenus Totaux</div>
        <div class="stat-value">{{ formatCurrency(getGlobalStats()?.totalRevenue || 0) }}</div>
        <div *ngIf="monthComparison" class="stat-change"
             [class.positive]="monthComparison.changes.revenueChange > 0"
             [class.negative]="monthComparison.changes.revenueChange < 0">
          {{ getChangeDisplay(monthComparison.changes.revenueChange, monthComparison.changes.revenueChangePercent) }}
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon green">
        <i class="fas fa-chart-pie"></i>
      </div>
      <div class="stat-content">
        <div class="stat-title">Marge Brute</div>
        <div class="stat-value">{{ formatPercentage(getGlobalStats()?.grossMarginPercentage || 0) }}</div>
        <div class="stat-subtitle">{{ formatCurrency(getGlobalStats()?.totalGrossMargin || 0) }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon orange">
        <i class="fas fa-coins"></i>
      </div>
      <div class="stat-content">
        <div class="stat-title">Dépenses d'Exploitation</div>
        <div class="stat-value">{{ formatCurrency(getGlobalStats()?.totalOperatingExpenses || 0) }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon purple">
        <i class="fas fa-hand-holding-usd"></i>
      </div>
      <div class="stat-content">
        <div class="stat-title">Bénéfice Net</div>
        <div class="stat-value">{{ formatCurrency(getGlobalStats()?.totalNetProfit || 0) }}</div>
        <div *ngIf="monthComparison" class="stat-change"
             [class.positive]="monthComparison.changes.profitChange > 0"
             [class.negative]="monthComparison.changes.profitChange < 0">
          {{ getChangeDisplay(monthComparison.changes.profitChange, monthComparison.changes.profitChangePercent) }}
        </div>
      </div>
    </div>
  </div>

  <!-- Section d'information sur les données -->
  <div class="info-card" *ngIf="profitabilityData && !isLoading">
    <div class="info-content">
      <i class="fas fa-info-circle"></i>
      <div class="info-text">
        <strong>Note :</strong> Les coûts directs incluent les produits, l'eau et l'électricité.
        Si vous voyez des valeurs à 0 FCFA, vérifiez que les dépenses de type "Produit", "Eau", "Électricité" sont bien enregistrées dans le système.
      </div>
    </div>
  </div>

  <!-- Tableau d'analyse de rentabilité -->
  <div class="form-card" *ngIf="profitabilityData && !isLoading">
    <div class="form-header">
      <h2 class="form-title">Détails de la Rentabilité par Centre</h2>
      <p class="form-subtitle">
        Période: {{ getGlobalStats()?.startDate | date:'dd/MM/yyyy' }} -
        {{ getGlobalStats()?.endDate | date:'dd/MM/yyyy' }}
      </p>
      <div class="period-info">
        <span class="info-badge">
          <i class="fas fa-calendar"></i>
          Données du mois en cours
        </span>
      </div>
    </div>

    <div class="table-container">
      <table class="profitability-table">
        <thead>
          <tr>
            <th>Centre</th>
            <th>Revenus</th>
            <th>Coûts directs</th>
            <th>Marge brute</th>
            <th>Frais d'exploitation</th>
            <th>Bénéfice net</th>
            <th>Marge nette</th>
            <th>Retour sur Investissement</th>
          </tr>
        </thead>
        <tbody>
          <!-- Lignes pour chaque centre -->
          <tr *ngFor="let centre of getCentreDetails()" class="centre-row">
            <td class="centre-name">
              <i class="fas fa-store"></i>
              {{ centre.centreName }}
            </td>
            <td class="revenue">{{ formatCurrency(centre.totalRevenue) }}</td>
            <td class="direct-costs">{{ formatCurrency(centre.directCosts) }}</td>
            <td class="gross-margin">{{ formatCurrency(centre.grossMargin) }}</td>
            <td class="operating-expenses">{{ formatCurrency(centre.operatingExpenses) }}</td>
            <td class="net-profit"
                [class.positive-value]="isPositive(centre.netProfit)"
                [class.negative-value]="!isPositive(centre.netProfit)">
              {{ formatCurrency(centre.netProfit) }}
            </td>
            <td class="net-margin"
                [class.positive-value]="isPositive(centre.netMarginPercentage)"
                [class.negative-value]="!isPositive(centre.netMarginPercentage)">
              {{ formatPercentage(centre.netMarginPercentage) }}
            </td>
            <td class="roi"
                [class.positive-value]="isPositive(centre.roi)"
                [class.negative-value]="!isPositive(centre.roi)"
                [class.high-roi]="centre.roi > 100">
              {{ formatPercentage(centre.roi) }}
            </td>
          </tr>

          <!-- Ligne de total -->
          <tr *ngIf="getGlobalStats()" class="total-row">
            <td class="total-label">
              <strong>Total Général</strong>
            </td>
            <td class="total-value"><strong>{{ formatCurrency(getGlobalStats()!.totalRevenue) }}</strong></td>
            <td class="total-value"><strong>{{ formatCurrency(getGlobalStats()!.totalDirectCosts) }}</strong></td>
            <td class="total-value"><strong>{{ formatCurrency(getGlobalStats()!.totalGrossMargin) }}</strong></td>
            <td class="total-value"><strong>{{ formatCurrency(getGlobalStats()!.totalOperatingExpenses) }}</strong></td>
            <td class="total-value"
                [class.positive-value]="isPositive(getGlobalStats()!.totalNetProfit)"
                [class.negative-value]="!isPositive(getGlobalStats()!.totalNetProfit)">
              <strong>{{ formatCurrency(getGlobalStats()!.totalNetProfit) }}</strong>
            </td>
            <td class="total-value"
                [class.positive-value]="isPositive(getGlobalStats()!.netMarginPercentage)"
                [class.negative-value]="!isPositive(getGlobalStats()!.netMarginPercentage)">
              <strong>{{ formatPercentage(getGlobalStats()!.netMarginPercentage) }}</strong>
            </td>
            <td class="total-value"
                [class.positive-value]="isPositive(getGlobalStats()!.averageROI)"
                [class.negative-value]="!isPositive(getGlobalStats()!.averageROI)"
                [class.high-roi]="getGlobalStats()!.averageROI > 100">
              <strong>{{ formatPercentage(getGlobalStats()!.averageROI) }}</strong>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Légende -->
    <div class="table-legend">
      <div class="legend-item">
        <span class="legend-color positive"></span>
        <span>Performance positive</span>
      </div>
      <div class="legend-item">
        <span class="legend-color negative"></span>
        <span>Performance négative</span>
      </div>
      <div class="legend-item">
        <span class="legend-color high-roi"></span>
        <span>Retour sur Investissement (>100%)</span>
      </div>
    </div>

    <!-- Message si pas de données -->
    <div *ngIf="getCentreDetails().length === 0" class="no-data-message">
      <i class="fas fa-chart-bar"></i>
      <p>Aucune donnée de rentabilité disponible pour cette période.</p>
      <button class="btn btn-outline" (click)="refreshData()">
        <i class="fas fa-sync"></i> Réessayer
      </button>
    </div>
  </div>
</div>

    <div class="footer">
      <div>©2026 AutoWash, Tous droit reservé.</div>
      <div>Crée par <a href="https://www.linkedin.com/in/afferyauxencedelorschabehou/">Affery Auxence Delors
          CHABEHOU</a></div>
    </div>
  </div>
</body>

</html>
