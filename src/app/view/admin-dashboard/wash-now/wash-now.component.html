<html lang="fr">

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css" rel="stylesheet">
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <i class="fas fa-hashtag"></i> AUTOWASH
    </div>
    <div class="user-profile">
      <img [src]="currentUser?.photoSafeUrl" [alt]="'Photo de ' + (currentUser?.firstName || 'Utilisateur')"
        class="user-avatar">
      <div class="user-info">
        <h4>
          <h4>{{ getFullName() }}</h4>
          <p>{{ getUserRole() }}</p>
        </h4>
      </div>
    </div>
    <div class="nav-menu">
      <!-- Dashboard -->
      <div class="dropdown dropdown-hover">
        <a class="nav-item active" data-mdb-dropdown-init [routerLink]="['/admin/dashboard']">
          <i class="fas fa-tachometer-alt"></i>
          <span>Tableau de bord</span>
        </a>
      </div>

      <!-- Gestion des Utilisateurs -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-users-cog"></i>
          <span>Utilisateurs</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/users-list']"><i class="fas fa-list"></i> Liste des
              utilisateurs</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/users-create']"><i class="fas fa-user-plus"></i> Ajouter
              un utilisateur</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/users-attendance']"><i class="fas fa-user-clock"></i>
              Présences</a></li>
        </ul>
      </div>

      <!-- Centres de Lavage -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fa-solid fa-car"></i>
          <span>Centres</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/centres-list']"><i class="fas fa-list"></i> Tous les
              centres</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/centres-create']"><i class="fas fa-plus-circle"></i>
              Nouveau centre</a></li>
        </ul>
      </div>

      <!-- Sessions de Lavage -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-car-side"></i>
          <span>Lavages</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/wash-sessions']"><i class="fas fa-list"></i> Toutes les
              sessions</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/wash-now']"><i class="fas fa-play-circle"></i> Nouveau
              lavage</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/wash-queue']"><i class="fas fa-clock"></i> File
              d'attente</a></li>
        </ul>
      </div>

      <!-- Paiements -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-money-bill-wave"></i>
          <span>Paiements</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-washers']"><i class="fas fa-user-tie"></i>
              Paiements laveurs</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-customers']"><i class="fas fa-users"></i>
              Paiements clients</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-manager']"><i class="fas fa-user-tie"></i>
              Paiement gérant</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/payments-reports']"><i
                class="fas fa-file-invoice-dollar"></i> Rapports</a></li>
        </ul>
      </div>

      <!-- Stocks -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-box-open"></i>
          <span>Stocks</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-list']"><i class="fas fa-boxes"></i> Inventaire</a>
          </li>
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-alerts']"><i
                class="fas fa-exclamation-triangle"></i> Alertes stock</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-movements']"><i class="fas fa-exchange-alt"></i>
              Mouvements</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/stocks-suppliers']"><i class="fas fa-truck"></i>
              Fournisseurs</a></li>
        </ul>
      </div>

      <!-- Statistiques & Rapports -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-chart-pie"></i>
          <span>Statistiques</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-daily']"><i class="fas fa-calendar-day"></i>
              Journalier</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-weekly']"><i class="fas fa-calendar-week"></i>
              Hebdomadaire</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-monthly']"><i class="fas fa-calendar-alt"></i>
              Mensuel</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-comparison']"><i class="fas fa-balance-scale"></i>
              Comparaison</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/reports-export']"><i class="fas fa-file-export"></i>
              Exports</a></li>
        </ul>
      </div>

      <!-- Audit -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-clipboard-check"></i>
          <span>Audit</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/audit-logs']"><i class="fas fa-clipboard-list"></i>
              Journal d'activité</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/audit-changes']"><i class="fas fa-history"></i> Historique
              modifications</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/audit-security']"><i class="fas fa-shield-alt"></i>
              Sécurité</a></li>
        </ul>
      </div>

      <!-- Dépenses -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Dépenses</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/expenses-utilities']"><i class="fas fa-tint"></i>Gestion
              dépenses</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/expenses-profitability']"><i
                class="fas fa-chart-line"></i> Rentabilité</a></li>
        </ul>
      </div>

      <!-- Paramètres -->
      <div class="dropdown dropdown-hover">
        <button class="nav-item" data-mdb-dropdown-init>
          <i class="fas fa-cogs"></i>
          <span>Paramètres</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-hover">
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-schedule']"><i class="fas fa-clock"></i>
              Horaires</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-services']"><i class="fas fa-concierge-bell"></i>
              Prestations</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-vehicles']"><i class="fas fa-car"></i> Types de
              véhicules</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-notifications']"><i class="fas fa-bell"></i>
              Notifications</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-system']"><i class="fas fa-sliders-h"></i>
              Système</a></li>
          <li><a class="dropdown-item" [routerLink]="['/admin/settings-templates']"><i class="fas fa-file-alt"></i>
              Modèles de paramètres</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <div class="top-bar">
      <div class="menu-toggle" id="menu-toggle">
        <i class="fas fa-bars"></i>
      </div>
      <div class="top-right">
        <div class="icon-button">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="icon-button">
          <i class="fas fa-bell"></i>
          <span class="badge">3</span>
        </div>
        <div class="dropdown dropdown-hover">
          <button class="user-dropdown" id="user-dropdown" data-mdb-dropdown-init>
            <!-- Photo sécurisée si elle existe -->
            <img *ngIf="currentUser?.photoSafeUrl as safeUrl" [src]="safeUrl" alt="User" class="user-avatar">
            <!-- Nom complet -->
            <span>{{ currentUser?.firstName }} {{ currentUser?.lastName }}</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-hover" id="user-dropdown-menu">
            <li><a class="dropdown-item" [routerLink]="['/admin/users-profil']"><i class="fas fa-user"></i> Mon
                profil</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Paramètres</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-envelope"></i> Inbox</a></li>
            <li><a class="dropdown-item" (click)="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="page-content">
      <div class="container-fluid">

        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <h2 class="page-title">
                <i class="fas fa-car-side text-primary me-2"></i> Nouveau Lavage
              </h2>
              <button class="btn btn-outline-secondary" routerLink="/admin/wash-sessions">
                <i class="fas fa-arrow-left me-2"></i> Retour
              </button>
            </div>
            <p class="text-muted">Enregistrez une nouvelle session de lavage pour un client</p>
          </div>
        </div>

        <div class="container-fluid">
          <div class="row mb-3" *ngIf="errorMessages.length > 0 || successMessage">
            <div class="col-12">
              <!-- Message spécifique pour Mobile Money -->
              <div class="alert alert-warning"
                *ngIf="selectedPaymentMethod === PaymentMethod.MOBILE_MONEY && isSubmitting">
                <i class="fas fa-mobile-alt me-2"></i>
                <strong>Traitement Mobile Money en cours...</strong>
                <div class="mt-2">
                  <div class="spinner-border spinner-border-sm me-2"></div>
                  Vérification du paiement, veuillez patienter...
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-lg-8">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                  <h5 class="card-title mb-0 text-primary">
                    <i class="fas fa-info-circle me-2"></i> Informations du lavage
                    <span class="spinner-border spinner-border-sm ms-2" *ngIf="isLoading"></span>
                  </h5>
                </div>
                <div class="card-body">
                  <form [formGroup]="washForm" (ngSubmit)="onSubmit()">

                    <!-- Section 1: Localisation -->
                    <div class="form-section">
                      <h6 class="form-section-title">
                        <i class="fas fa-map-marker-alt me-2"></i>Localisation
                      </h6>

                      <div class="row mb-3">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="centreId" class="form-label">Centre de lavage <span
                                class="text-danger">*</span></label>
                            <select id="centreId" class="form-select" formControlName="centreId"
                              [class.is-invalid]="washForm.get('centreId')?.invalid && washForm.get('centreId')?.touched">
                              <option value="" disabled>Sélectionnez un centre</option>
                              <option *ngFor="let centre of centres" [value]="centre.id">
                                {{ centre.name }} - {{ centre.location }}
                              </option>
                            </select>
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('centreId')?.invalid && washForm.get('centreId')?.touched">
                              Veuillez sélectionner un centre
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Section 2: Service et Véhicule -->
                    <div class="form-section">
                      <h6 class="form-section-title">
                        <i class="fas fa-car me-2"></i>Informations du véhicule
                      </h6>

                      <div class="row mb-3">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="serviceId" class="form-label">Type de service <span
                                class="text-danger">*</span></label>
                            <select id="serviceId" class="form-select" formControlName="serviceId"
                              [class.is-invalid]="washForm.get('serviceId')?.invalid && washForm.get('serviceId')?.touched"
                              [disabled]="!washForm.get('centreId')?.value">
                              <option value="" disabled>Sélectionnez un service</option>
                              <option *ngFor="let service of services" [value]="service.id">
                                {{ service.name }} - {{ service.basePrice }} FCFA
                              </option>
                            </select>
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('serviceId')?.invalid && washForm.get('serviceId')?.touched">
                              Veuillez sélectionner un service
                            </div>
                          </div>
                        </div>

                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="vehicleTypeId" class="form-label">Type de véhicule <span
                                class="text-danger">*</span></label>
                            <select id="vehicleTypeId" class="form-select" formControlName="vehicleTypeId"
                              [class.is-invalid]="washForm.get('vehicleTypeId')?.invalid && washForm.get('vehicleTypeId')?.touched">
                              <option value="" disabled>Sélectionnez un type</option>
                              <option *ngFor="let vehicleType of vehicleTypes" [value]="vehicleType.id">
                                {{ vehicleType.label }} (x{{ vehicleType.defaultSizeMultiplier }})
                              </option>
                            </select>
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('vehicleTypeId')?.invalid && washForm.get('vehicleTypeId')?.touched">
                              Veuillez sélectionner un type de véhicule
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="row mb-3">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="vehiclePlate" class="form-label">Immatriculation <span
                                class="text-danger">*</span></label>
                            <input type="text" id="vehiclePlate" class="form-control" formControlName="vehiclePlate"
                              placeholder="AB123CD" style="text-transform: uppercase"
                              [class.is-invalid]="washForm.get('vehiclePlate')?.invalid && washForm.get('vehiclePlate')?.touched">
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('vehiclePlate')?.invalid && washForm.get('vehiclePlate')?.touched">
                              Plaque requise (min 4 caractères)
                            </div>
                          </div>
                        </div>

                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="vehicleBrand" class="form-label">Marque</label>
                            <input type="text" id="vehicleBrand" class="form-control" formControlName="vehicleBrand"
                              placeholder="Ex: Toyota">
                          </div>
                        </div>

                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="vehicleColor" class="form-label">Couleur</label>
                            <input type="text" id="vehicleColor" class="form-control" formControlName="vehicleColor"
                              placeholder="Ex: Rouge">
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Section 3: Informations Client -->
                    <div class="form-section">
                      <h6 class="form-section-title">
                        <i class="fas fa-user me-2"></i>Informations client
                      </h6>

                      <div class="row mb-3">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="customerPhone" class="form-label">Téléphone <span
                                class="text-danger">*</span></label>
                            <div class="input-group">
                              <span class="input-group-text"><i class="fas fa-phone"></i></span>
                              <input type="tel" id="customerPhone" formControlName="customerPhone" class="form-control"
                                placeholder="+225 XX XX XX XX XX"
                                [class.is-invalid]="washForm.get('customerPhone')?.invalid && washForm.get('customerPhone')?.touched">
                            </div>
                            <small class="form-text text-muted" *ngIf="!isSearchingCustomer && !currentCustomer">
                              <i class="fas fa-search"></i> Recherche automatique du client
                            </small>
                            <small class="form-text text-primary" *ngIf="isSearchingCustomer">
                              <i class="fas fa-spinner fa-spin"></i> Recherche en cours...
                            </small>
                            <small class="form-text text-success" *ngIf="currentCustomer">
                              <i class="fas fa-check-circle"></i> Client trouvé: {{currentCustomer.name}}
                            </small>
                          </div>
                        </div>

                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="customerName" class="form-label">Nom complet <span
                                class="text-danger">*</span></label>
                            <div class="input-group">
                              <span class="input-group-text"><i class="fas fa-user"></i></span>
                              <input type="text" id="customerName" formControlName="customerName" class="form-control"
                                placeholder="Nom complet du client"
                                [class.is-invalid]="washForm.get('customerName')?.invalid && washForm.get('customerName')?.touched">
                            </div>
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('customerName')?.invalid && washForm.get('customerName')?.touched">
                              Le nom du client est obligatoire
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="row mb-3">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="customerEmail" class="form-label">
                              Email client
                              <span class="badge bg-secondary ms-2">Optionnel</span>
                            </label>
                            <div class="input-group">
                              <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                              <input type="email" id="customerEmail" class="form-control"
                                formControlName="customerEmail" placeholder="client@example.com"
                                [class.is-invalid]="washForm.get('customerEmail')?.invalid && washForm.get('customerEmail')?.touched">
                            </div>
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('customerEmail')?.errors?.['email'] && washForm.get('customerEmail')?.touched">
                              Format d'email invalide
                            </div>
                            <small class="form-text text-muted">
                              <i class="fas fa-info-circle"></i> Recommandé pour les notifications
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Section 4: Attribution Laveur -->
                    <div class="form-section">
                      <h6 class="form-section-title">
                        <i class="fas fa-user-check me-2"></i>Attribution
                      </h6>

                      <div class="row mb-3">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="washerId" class="form-label">Laveur attribué <span
                                class="text-danger">*</span></label>
                            <select id="washerId" class="form-select" formControlName="washerId"
                              [class.is-invalid]="washForm.get('washerId')?.invalid && washForm.get('washerId')?.touched"
                              [disabled]="!washForm.get('centreId')?.value || isLoadingWashers">
                              <option value="" disabled>
                                {{ isLoadingWashers ? 'Chargement...' : 'Sélectionnez un laveur' }}
                              </option>
                              <option *ngFor="let washer of filteredWashers" [value]="washer.id">
                                {{ washer.firstName }} {{ washer.lastName }} - {{ washer.email }}
                              </option>
                              <option *ngIf="!isLoadingWashers && filteredWashers.length === 0" value="" disabled>
                                Aucun laveur disponible
                              </option>
                            </select>
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('washerId')?.invalid && washForm.get('washerId')?.touched">
                              Veuillez sélectionner un laveur
                            </div>
                            <small class="form-text text-muted" *ngIf="filteredWashers.length > 0">
                              <i class="fas fa-users"></i> {{ filteredWashers.length }} laveur(s) disponible(s)
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Section 5: Paiement -->
                    <div class="form-section">
                      <h6 class="form-section-title">
                        <i class="fas fa-credit-card me-2"></i>Paiement
                      </h6>

                      <div class="row mb-3">
                        <div class="col-md-12">
                          <label class="form-label">Méthode de paiement <span class="text-danger">*</span></label>
                          <div class="payment-methods">
                            <div class="payment-method" [class.active]="selectedPaymentMethod === PaymentMethod.CASH"
                              (click)="onPaymentMethodChange(PaymentMethod.CASH)">
                              <i class="fas fa-money-bill-wave"></i>
                              <span>Espèces</span>
                            </div>
                            <div class="payment-method"
                              [class.active]="selectedPaymentMethod === PaymentMethod.MOBILE_MONEY"
                              (click)="onPaymentMethodChange(PaymentMethod.MOBILE_MONEY)">
                              <i class="fas fa-mobile-alt"></i>
                              <span>Mobile Money</span>
                            </div>
                            <div class="payment-method"
                              [class.active]="selectedPaymentMethod === PaymentMethod.CREDIT_CARD"
                              (click)="onPaymentMethodChange(PaymentMethod.CREDIT_CARD)">
                              <i class="fas fa-credit-card"></i>
                              <span>Carte bancaire</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- ID Transaction pour paiements électroniques -->
                      <div class="row mb-3" *ngIf="selectedPaymentMethod !== PaymentMethod.CASH">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="transactionId" class="form-label">
                              ID Transaction
                              <span class="text-danger">*</span>
                              <span class="badge bg-warning ms-2">Requis</span>
                            </label>
                            <div class="input-group">
                              <span class="input-group-text">
                                <i class="fas fa-receipt"></i>
                              </span>
                              <input type="text" id="transactionId" formControlName="transactionId" class="form-control"
                                placeholder="Ex: TXN123456789"
                                [class.is-invalid]="washForm.get('transactionId')?.invalid && washForm.get('transactionId')?.touched">
                            </div>
                            <div class="invalid-feedback"
                              *ngIf="washForm.get('transactionId')?.invalid && washForm.get('transactionId')?.touched">
                              L'ID de transaction est requis pour ce mode de paiement
                            </div>
                            <small class="form-text text-muted">
                              <i class="fas fa-info-circle"></i>
                              Saisissez la référence de transaction fournie par l'opérateur
                            </small>
                          </div>
                        </div>
                      </div>

                      <!-- Message d'information pour paiements électroniques -->
                      <div class="row mb-3" *ngIf="selectedPaymentMethod !== PaymentMethod.CASH">
                        <div class="col-md-12">
                          <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Pour les paiements électroniques, veuillez saisir l'ID de transaction fourni par
                            l'opérateur.
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Section 6: Options -->
                    <div class="form-section">
                      <h6 class="form-section-title">
                        <i class="fas fa-cog me-2"></i>Options supplémentaires
                      </h6>

                      <div class="row mb-3">
                        <div class="col-md-6">
                          <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="applyLoyaltyDiscount"
                              formControlName="applyLoyaltyDiscount" [disabled]="!canApplyLoyaltyDiscount">
                            <label class="custom-control-label" for="applyLoyaltyDiscount">
                              <i class="fas fa-star text-warning me-1"></i>
                              Remise fidélité (10%)
                            </label>
                            <small class="d-block text-muted ms-4">
                              {{ canApplyLoyaltyDiscount ? 'Client éligible' : 'Disponible après 5 lavages' }}
                            </small>
                          </div>
                        </div>

                        <div class="col-md-6"
                          *ngIf="currentUser && (getUserRole() === 'Administrateur' || getUserRole() === 'Manager')">
                          <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="isAdminOverride"
                              formControlName="isAdminOverride">
                            <label class="custom-control-label" for="isAdminOverride">
                              <i class="fas fa-shield-alt text-warning me-1"></i>
                              Override administrateur
                            </label>
                            <small class="d-block text-muted ms-4">
                              Force l'enregistrement
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Messages et Actions -->
                    <div class="alert alert-success" *ngIf="successMessage">
                      <i class="fas fa-check-circle me-2"></i>
                      {{ successMessage }}
                    </div>

                    <div class="alert alert-warning"
                      *ngIf="selectedPaymentMethod === PaymentMethod.MOBILE_MONEY && isSubmitting">
                      <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3"></div>
                        <div>
                          <strong>Traitement Mobile Money en cours...</strong>
                          <p class="mb-0 small">Vérification du paiement, veuillez patienter...</p>
                        </div>
                      </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="form-actions">
                      <button type="button" class="btn btn-secondary btn-lg" (click)="resetForm()"
                        [disabled]="isSubmitting">
                        <i class="fas fa-redo me-2"></i> Réinitialiser
                      </button>

                      <button type="submit" class="btn btn-primary btn-lg"
                        [disabled]="washForm.invalid || isSubmitting">
                        <span class="spinner-border spinner-border-sm me-2" *ngIf="isSubmitting"></span>
                        <i class="fas fa-save me-2" *ngIf="!isSubmitting"></i>
                        {{ isSubmitting ? 'Enregistrement...' : 'Enregistrer le lavage' }}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                  <h6 class="card-title mb-0">
                    <i class="fas fa-calculator me-2"></i> Calcul du prix
                  </h6>
                </div>
                <div class="card-body">
                  <div *ngIf="isCalculatingPrice" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">Calcul en cours...</p>
                  </div>

                  <div *ngIf="priceCalculation && !isCalculatingPrice">
                    <div class="mb-3">
                      <div class="d-flex justify-content-between mb-2">
                        <span>Prix de base:</span>
                        <span>{{ priceCalculation.basePrice }} FCFA</span>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>Multiplicateur véhicule:</span>
                        <span>x{{ priceCalculation.vehicleMultiplier }}</span>
                      </div>
                      <div class="d-flex justify-content-between mb-2" *ngIf="loyaltyDiscount > 0">
                        <span class="text-success">Remise fidélité:</span>
                        <span class="text-success">-{{ priceCalculation.loyaltyDiscount }} FCFA</span>
                      </div>
                      <hr>
                      <div class="d-flex justify-content-between fs-5 fw-bold text-primary">
                        <span>Total à payer:</span>
                        <span>{{ priceCalculation.finalPrice }} FCFA</span>
                      </div>
                    </div>
                  </div>

                  <div class="alert alert-success mt-3" *ngIf="loyaltyDiscountApplied">
                    <i class="fas fa-gift me-2"></i>
                    <strong>{{ loyaltyDiscountMessage }}</strong>
                    <p class="mb-0 small">10% de réduction appliquée automatiquement</p>
                  </div>

                  <div *ngIf="!priceCalculation && !isCalculatingPrice" class="text-center py-3 text-muted">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>Sélectionnez un service et un type de véhicule pour voir le prix</p>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm border-0 mb-4" *ngIf="currentCustomer">
                <div class="card-header bg-info text-white">
                  <h6 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i> Profil client
                  </h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <strong>{{ currentCustomer.name }}</strong>
                    <br>
                    <small class="text-muted">{{ currentCustomer.phone }}</small>
                  </div>

                  <div class="row text-center">
                    <div class="col-6">
                      <div class="border-end">
                        <div class="fs-4 fw-bold text-primary">{{ currentCustomer.totalCompletedBookings || 0 }}</div>
                        <small class="text-muted">Lavages</small>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="fs-4 fw-bold text-success">
                        {{ customerTotalSpent.toFixed(0) }} FCFA
                      </div>
                      <small class="text-muted">Dépensé</small>
                    </div>
                  </div>

                  <div class="mt-3" *ngIf="canApplyLoyaltyDiscount">
                    <div class="alert alert-success alert-sm mb-0">
                      <i class="fas fa-star me-1"></i>
                      <strong>Client fidèle!</strong> Éligible à la remise de 10%
                    </div>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm border-0 mb-3" *ngIf="currentCustomer">
                <div class="card-header bg-info text-white">
                  <h6 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i> Informations détaillés client
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-8">
                      <p class="mb-1"><strong>Nom complet :</strong> {{ currentCustomer.name }}</p>
                      <p class="mb-1"><strong>Téléphone :</strong> {{ currentCustomer.phone }}</p>
                      <p class="mb-1"><strong>Email :</strong> {{ currentCustomer.email || 'N/A' }}</p>
                      <p class="mb-1"><strong>Inscrit depuis :</strong> {{ currentCustomer.createdAt |
                        date:'dd/MM/yyyy'
                        }}</p>
                    </div>
                    <div class="col-md-8">
                      <p class="mb-1"><strong>Total lavages :</strong> {{ currentCustomer.totalCompletedBookings }}</p>
                      <p class="mb-1"><strong>Dernière visite :</strong> {{ currentCustomer.lastVisit |
                        date:'dd/MM/yyyy'
                        }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm border-0" *ngIf="customerHistory && customerHistory.length > 0">
                <div class="card-header bg-secondary text-white">
                  <h6 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i> Derniers lavages ({{ customerHistory.length }})
                  </h6>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush">
                    <div class="list-group-item" *ngFor="let wash of customerHistory; let i = index">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <h6 class="mb-1">{{ wash.customer.name || wash.customer.phoneNumber || 'N/A' }}</h6>
                          <p class="mb-1 text-muted small">
                            {{ wash.vehiclePlate }} - {{ wash.vehicleBrand || 'N/A' }}
                            <span class="text-info ms-2">({{ wash.vehicleColor || 'N/A' }})</span>
                          </p>
                          <small class="text-muted">{{ wash.createdAt | date:'dd/MM/yyyy HH:mm' }}</small>
                        </div>
                        <div class="text-end">
                          <span class="badge bg-success mb-1">{{ wash.price }} FCFA</span>
                          <small class="badge"
                            [class]="wash.isCompleted ? 'bg-success' : wash.isCancelled ? 'bg-danger' : 'bg-warning'">
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm border-0"
                *ngIf="currentCustomer && (!customerHistory || customerHistory.length === 0)">
                <div class="card-body text-center text-muted">
                  <i class="fas fa-info-circle fa-2x mb-2"></i>
                  <p class="mb-0">Aucun historique de lavage trouvé pour ce client</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>©2026 AutoWash, Tous droit reservé.</div>
      <div>Crée par <a href="https://www.linkedin.com/in/afferyauxencedelorschabehou/">Affery Auxence Delors
          CHABEHOU</a></div>
    </div>
  </div>
</body>

</html>
